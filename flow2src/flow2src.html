<style>
    .red-ui-tray-content #dialog-form {
    white-space:nowrap;
}
.full-row .red-ui-typedInput-container {
    min-width: 70%;
}
.col input {
    min-width: 100%;
}
.sml-lbl {
    height: 66px;
}
.sml-lbl label {
    font-size: smaller;
    margin-bottom: 0px;
    display: block!important;
}
.reg-lbl label {
    white-space: nowrap;
    margin-top: 5px;
    height: 0px;
}
.red-ui-editor .form-row label.full-lbl {
    white-space: normal;
    width: 100%;
}
.col {
    float: left;
    margin-right: 5px;
    min-height: 36px;
}
.col .red-ui-typedInput-container {
    width: 100%!important;
}
.col-50 {
    width: 50%;
}
.col-33 {
    width: 33%;
}
.col-66 {
    width: 66%;
}
.col-25 {
    width: 25%;
}
.col-75 {
    width: 75%;
}
.col-100 .red-ui-typedInput-container {
    width: 70%!important;
}
.col-100.no-label .red-ui-typedInput-container {
    width: 100%!important;
}
.txtarea {
    padding-bottom: 26px;
}
.txtarea label {
    vertical-align: top;
    margin-top: 3px;
}
.txtarea  textarea {
    width: 70%;
    margin-bottom: -28px!important;
}
.btn-regular {
    margin-bottom: 14px!important;
}
.red-ui-editableList-item-content {
    display: inline-block;
    margin-bottom: -6px;
    width: -moz-available;
    width: -webkit-fill-available;
    width: fill-available;
}
.red-ui-editableList-item-content .sml-lbl {
    height: auto;
}

</style>
<script type="text/html" data-template-name="flow2src">
    
    <div id="node-props" style="width: 460px;">
                <div class="form-row">
            <div class="col-100 reg-lbl">
                <label class="full-lbl">
                    <span>Flow-to-Src will write the flow source properties to the src folder. Use Src-to-Flow to integrate changes back into the flow (the web browser will refresh).</span>
                </label>
            </div><!--col-->
        </div><!--form-row-->
        <div class="form-row" style="margin-right:10px;">
            <div class="col col-25 reg-lbl">
                <label class="full-lbl">
                    <i class="fa fa-bolt"></i> <span>Action</span>
                </label>
            </div><!--col-->
            <div class="col col-25">
                <button id="btn_flow2src" type="button" class="red-ui-button btn-regular"><i class="fa fa-download"></i> Flow-to-Src</button>
            </div>
            <div class="col col-25">
                <button id="btn_src2flow" type="button" class="red-ui-button btn-regular"><i class="fa fa-upload"></i> Src-to-Flow</button>
            </div>
            <div style="margin-right:-15px;" class="col col-25 reg-lbl">
                <label class="full-lbl">
                    <span></span>
                </label>
            </div><!--col-->
        </div><!--form-row-->
        <div class="form-row">
            <div class="col-100 reg-lbl">
                <label class="full-lbl">
                    <span>Comma delimited list of flows to include (use * for all):</span>
                </label>
            </div><!--col-->
        </div><!--form-row-->
        <div class="form-row">
            <div class="col-100">
                <label for="node-input-incFlows">Flows</label>
                <input type="text" id="node-input-incFlows" placeholder="">
                
            </div><!--col-->
        </div><!--form-row-->
        <div class="form-row">
            <div class="col-100 reg-lbl">
                <label class="full-lbl">
                    <span>Comma delimited list of subflows to include (use * for all):</span>
                </label>
            </div><!--col-->
        </div><!--form-row-->
        <div class="form-row">
            <div class="col-100">
                <label for="node-input-incSubflows">Subflows</label>
                <input type="text" id="node-input-incSubflows" placeholder="">
                
            </div><!--col-->
        </div><!--form-row-->
        <div class="form-row">
            <div class="col-100 reg-lbl">
                <label class="full-lbl">
                    <span>The output folder relative to the flow file:</span>
                </label>
            </div><!--col-->
        </div><!--form-row-->
        <div class="form-row">
            <div class="col-100">
                <label for="node-input-srcFolder">Output Folder</label>
                <input type="text" id="node-input-srcFolder" placeholder="src">
                
            </div><!--col-->
        </div><!--form-row-->
        <div class="form-row">
            <div class="col col-25 reg-lbl">
                <label class="full-lbl">
                    <span></span>
                </label>
            </div><!--col-->
            <div style="margin-right:-5px;" class="col col-75 reg-lbl">
                <label for="node-input-chkAutoFlow2Src" style="width:18px;">
                <input type="checkbox" id="node-input-chkAutoFlow2Src" name="node-input-chkAutoFlow2Src" style="margin-top:-3px;" >Automatically Flow-to-Src on Deploys</label>
            </div><!--col-->
        </div><!--form-row-->
    </div><!--node-props-->
</script>

<script type="text/markdown" data-help-name="flow2src">
    
# node-red-flow2src
Now you can easily see git diff, use CLI editors, or third-party IDEs like Visual Studio Code to leverage Co-Pilot with
your Node-RED based projects. This node will write template and function node source code properties to a src sub-folder
adjacent to the project's flows file; and it will allow you to merge changes back into your flows when you're done
editing.

## How to Use flow2src
Simply include the flow2src node on one of your project's flows. When enabling [Node-RED's project
mode](https://nodered.org/docs/user-guide/projects/), the files can be easily managed within Node-RED itself. See the
screenshot below for reference:

1) Include the flow2src node on one of your flows and open its property sheet.
2) Click the "Flow-to-Src" button; flow2src will generate the files.
3) Click Node-RED's "Refresh changes" button in the history tab.

![screenshot of node-maker](https://raw.github.com/steveorevo/node-red-flow2src/main/images/flow2src.jpg)

By default, flow2src will look for all flows and subflows for template and function nodes and create a src folder.
Within the src folder are a number of subfolders of the same name as your flow tabs and subflows. Source code files with
properly named
extensions (i.e. .js, .html, .json, .css, etc.) are written to the folders. The filename extensions are derived from the
node type (i.e. function node creates .js files) or the 'Syntax Highlight' mode setting for [template
nodes](https://nodered.org/docs/user-guide/nodes#template). You can override the filename extension by explicitly naming
your node with an extension. Nodes that share the same name within a given flow will automatically be iterated, i.e.
function_1.js, function_2.js, etc.

After making edits to the files in your src folder; use the "Src-to-Flow" button to merge changes back into your flow
file.

### Options
You can further customize which flows and subflows are exported and where they are exported using the following textbox
options:

* Flows - specify a flow by name, or mulitple flows by seperating names by a comma. Use an asterick for all flows.
* Subflows - specify a subflow by name, or mulitple subflows by seperating names by a comma. Use an asterick for all
subflows.
* Output Folder - By default the folder is named 'src'; you can specify a different path relative to your project's flow
file.

Lastly, you can invoke the "Flow-to-Src" button automatically using the checkbox for "Automatiaclly Flow-to-Src on
Deploys".
</script>

<script type="text/javascript">
    RED.nodes.registerType('flow2src', {
        category: 'common',
        color: '#B0DDB0',
        defaults: {
            name: {value:""},
                        incFlows: {value:"*"},
            incSubflows: {value:"*"},
            srcFolder: {value:"src"},
            chkAutoFlow2Src: {value:false}
        },
        inputs: 0,
        outputs: 0,
        icon: "font-awesome/fa-folder-open",
        label: function() {
            return this.name || "flow2src";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            
            // Allow dynamic re-size after init. appearance 
            setTimeout(function () {
                $('#node-props').css('width', '100%');
            }, 30);
            var node = this;
            $('#btn_flow2src').click(function(){
                doAjax({"action":'flow2src', "srcFolder": node.srcFolder}, node.id, function(res){
                    $('#node-dialog-ok').click();
                    let notice = RED.notify('Flow source properties written to "./' + node.srcFolder + '" folder.', {
                        type: "success",
                        timeout: 3000
                    });
                });
            });
            $('#btn_src2flow').click(function(){
                doAjax({"action":'src2flow', "srcFolder": node.srcFolder}, node.id, function(res) {
                    reloadFlows(function() {
                        $('#node-dialog-ok').click();
                    });
                });
            });
        },
        oneditresize: function() {
            
        
        },
        oneditsave: function() {
            

        },
        oneditcancel: function() {
            

        }
    });
    

    function doAjax(d, id, cb) {
        $.ajax({
            url: "flow2src/" + id,
            type: "POST",
            data: JSON.stringify(d),
            contentType: "application/json; charset=utf-8",
            complete: cb,
            error: function (jqXHR, textStatus, errorThrown) {
                if (jqXHR.status == 404) {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                } else if (jqXHR.status == 500) {
                    RED.notify(node._("common.notification.error", { message: node._("flow2src.errors.failed") }), "error");
                } else if (jqXHR.status == 0) {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                } else {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                }
            }
        });
    }
    function reloadFlows(cb) {
        $.ajax({
            url: "flows",
            type: "POST",
            data: JSON.stringify({}),
            contentType: "application/json; charset=utf-8",
            headers: {
                'Node-RED-Deployment-Type': 'reload'
            },
            complete: cb,
            error: function (jqXHR, textStatus, errorThrown) {
                if (jqXHR.status == 404) {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                } else if (jqXHR.status == 500) {
                    RED.notify(node._("common.notification.error", { message: node._("flow2src.errors.failed") }), "error");
                } else if (jqXHR.status == 0) {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                } else {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                }
            }
        });
    }
</script>
